{% extends "layout.html" %}

{% block content %}
<div class="text-center">
    <div class="card p-4">
        <h1 class="mb-4">Take Attendance</h1>

        <div class="form-group">
            <label for="subject">Select Subject:</label>
            <select id="subject" name="subject">
                {% for subject in subjects %}
                    <option value="{{ subject }}">{{ subject }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="stream">Select Stream:</label>
            <select id="stream" name="stream">
                {% for stream in streams %}
                    <option value="{{ stream }}">{{ stream }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="sem">Select Semester:</label>
            <select id="sem" name="sem">
                {% for sem in sems %}
                    <option value="{{ sem }}">{{ sem }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="camera">Select Camera:</label>
            <select id="camera" name="camera">
                {% for camera in cameras %}
                    <option value="{{ camera }}">Camera {{ camera }}</option>
                {% endfor %}
            </select>
        </div>

        <div id="statusMessage" class="alert alert-info" role="alert">
            Select filters and click "Start Scanning" to begin.
        </div>

        <button id="controlButton" class="btn btn-primary mb-4">Start Scanning</button>
        
        <div id="video-container" class="video-wrapper" style="display: none;">
            <img src="" id="video-feed" class="video-feed-img">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const controlButton = document.getElementById('controlButton');
        const videoContainer = document.getElementById('video-container');
        const videoFeed = document.getElementById('video-feed');
        const statusMessage = document.getElementById('statusMessage');
        const subjectSelect = document.getElementById('subject');
        const streamSelect = document.getElementById('stream');
        const semSelect = document.getElementById('sem');
        const cameraSelect = document.getElementById('camera');

        controlButton.addEventListener('click', function() {
            const subject = subjectSelect.value;
            const stream = streamSelect.value;
            const sem = semSelect.value;
            const camera = cameraSelect.value;

            if (!subject || !stream || !sem) {
                alert("Please select a subject, stream, and semester.");
                return;
            }

            const currentState = controlButton.getAttribute('data-state');

            if (currentState === 'scanning') {
                controlButton.setAttribute('data-state', 'not scanning');
                // --- This runs when you click "Next Student" ---
                // Reload the video feed to start a new liveness check cycle.
                // A timestamp prevents the browser from caching the URL, ensuring a fresh request.
                videoFeed.src = `{{ url_for('video_feed') }}?subject=${subject}&stream=${stream}&sem=${sem}&camera=${camera}&t=${new Date().getTime()}`;
                statusMessage.className = 'alert alert-info';
                statusMessage.innerText = 'Ready for next student. Click again to start.';
            } else {
                // --- This runs when you click "Start Scanning" for the first time ---
                videoContainer.style.display = 'block';
                
                // Construct the initial URL to start the feed and reset the backend state
                const initialUrl = `{{ url_for('video_feed') }}?subject=${subject}&stream=${stream}&sem=${sem}&camera=${camera}&start=true`;
                videoFeed.src = initialUrl;
                
                statusMessage.className = 'alert alert-warning';
                statusMessage.innerText = 'Initializing... Please wait for instructions.';
                
                // Update button state
                controlButton.textContent = 'Next Student';
                controlButton.className = 'btn btn-success btn-lg';
                controlButton.setAttribute('data-state', 'scanning');

                // Disable filters
                subjectSelect.disabled = true;
                streamSelect.disabled = true;
                semSelect.disabled = true;
                cameraSelect.disabled = true;
            }
        });
    });
</script>
{% endblock %}